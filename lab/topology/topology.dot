// Topology for Terraform lab: two VPCs (server, client), peered
// Design updates: single public/private subnets, client VPC has only a public subnet (no NAT),
// and the optional Tailscale subnet-router now lives in the server public subnet with a public IP.

digraph lab_topology {
  rankdir=LR;
  node [shape=box, style=rounded, fontsize=10];

  Internet [shape=cloud, label="Internet"];

  subgraph cluster_server_vpc {
    label = "VPC: server (10.10.0.0/16)";
    style = "dashed";

    server_public [label="Public Subnet\n(IGW)\n(Subnet router)", shape=component];
    server_private [label="Private Subnet\n(EKS nodes)", shape=component];

    eks_cluster [label="EKS Cluster\n(master control plane)", shape=oval];
    eks_nodes [label="EKS Node Group\n(t3.small x2)", shape=box];
    hello_app [label="hello Deployment\nClusterIP service", shape=note];
    tailscale_operator [label="Tailscale Operator (Helm)", shape=note];

    server_public -> server_private [style=invis];
    server_private -> eks_nodes;
    eks_nodes -> hello_app;
    eks_cluster -> tailscale_operator;
  }

  subgraph cluster_client_vpc {
    label = "VPC: client (10.20.0.0/16)";
    style = "dashed";
    client_public [label="Public Subnet\n(IGW)", shape=component];

    ubuntu_vm [label="Ubuntu VM (t3.small)\nTailscale client", shape=box];

    # client has no private subnets and no NAT gateway in the simplified design
    client_public -> ubuntu_vm;
  }

  // VPC peering removed â€” connectivity via Tailscale overlay
  // (no explicit VPC peering connection between server and client in this design)

  // Internet connectivity
  server_public -> Internet [style=dashed, label="IGW", fontsize=9];
  client_public -> Internet [style=dashed, label="IGW", fontsize=9];

  // Logical relationships
  tailscale_operator -> hello_app [label="manages Tailscale resources in-cluster", fontsize=9];
  ubuntu_vm -> Internet [style=dotted, label="egress via NAT", fontsize=9];
}
